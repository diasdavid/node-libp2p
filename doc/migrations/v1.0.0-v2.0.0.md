<!--Specify versions for migration below-->
# Migrating to libp2p@2.0 <!-- omit in toc -->

A migration guide for refactoring your application code from libp2p `v1.0.0` to `v2.0.0`.

## Table of Contents <!-- omit in toc -->

- [The autodialer has been removed](#the-autodialer-has-been-removed)
- ["Transient" connections have been renamed "limited"](#transient-connections-have-been-renamed-limited)
- [The CustomEvent polyfill has been removed from `@libp2p/interface`](#the-customevent-polyfill-has-been-removed-from-libp2pinterface)
- [`localPeer` is no longer passed to Connection Encrypters](#localpeer-is-no-longer-passed-to-connection-encrypters)
- [The `.code` property has been removed from thrown errors, use `.name` instead](#the-code-property-has-been-removed-from-thrown-errors-use-name-instead)
- [pubsub, identify, circuit-relay v2 and record envelope sealing use `privateKey` component](#pubsub-identify-circuit-relay-v2-and-record-envelope-sealing-use-privatekey-component)

## The autodialer has been removed

The libp2p autodialer was a component that attempted to ensure a minimum number
of connections were open at any point in time.

When the number of active connections dropped below a configured threshold, it
did this by searching the peer store for known peers which it then sorted by a
number of criteria - tag value, recent connections, etc, and would dial them
until the connection count was above the minimum value.

Opening connections is an expensive operation, and nodes that have unstable
network conditions will find themselves dialing peers more frequently. This has
an adverse effect on, for example mobile clients, which would then activate the
radio more frequently and consume more battery power.

The strategies for peer access vary considerably by protocol. For example
gossipsub may wish to maintain connections to mesh peers for certain topics in
order to send/receive messages promptly, but KAD-DHT may just wish to know the
addresses of a range of peers in the ID space outside of the first KAD-bucket
and not have a need to be constantly connected to them.

To that end individual protocols can ensure that they have sufficient
connections for their purposes and libp2p will not try to second-guess their
rules to apply at a global level.

**Before**

```ts
import { createLibp2p } from 'libp2p'

const node = await createLibp2p({
  // other config
  connectionManager: {
    // configure the autodialer
    minConnections: 10
  }
})
```

**After**

```ts
import { createLibp2p } from 'libp2p'

const node = await createLibp2p({
  // other config
})
```

## "Transient" connections have been renamed "limited"

In libp2p terms, a `transient` connection is one that has limits applied to it
for how long it's expected to remain open and/or how much data can be
transferred over it.

The most common place this type of connection will be encountered of this is one
that is via a [v2 Circuit Relay](https://github.com/libp2p/specs/blob/master/relay/circuit-v2.md).

The actual limits are applied by the relay server and reported to both ends of
the connection. They are optional so the connection may not have any limits and
could be treated as a regular connection.

The intention is for network nodes to run v2 Circuit Relay servers as a public
good that allows nodes to create direct connections via, for example WebRTC.

To prevent abuse, a relay will normally apply strict time/transfer limits, and
only have a limited number of relay slots so as to not run as an open relay.

`go-libp2p@0.34.0` included a breaking change of renaming `transient`
connections as `limited`.

`js-libp2p@2.0.0` adopts the same nomenclature so we can be sure we're talking
about the same thing.

**Before**

```ts
import { createLibp2p } from 'libp2p'
import { multiaddr } from '@multiformats/multiaddr'

const node = await createLibp2p({
  // other config
})

// dial a peer
const conn = await node.dial(multiaddr('/ip4/...'), {
  signal: AbortSignal.timeout(1000)
})

// is the connection transient?
console.info(conn.transient) // true | false

// register a protocol handler for incoming protocol dials
node.handle('/my-protocol/1.0.0', ({ stream, connection }) => {
  // handle protocol
}, {
   runOnTransientConnection: true
})

// register a topology that is notified of peers connecting over transient
// connections
node.register('/my-protocol/1.0.0', {
  onConnect: (peer, connection) => {
    // handle connect
  },
  notifyOnTransient: true
})
```

**After**

```ts
import { createLibp2p } from 'libp2p'

const node = await createLibp2p({
  // other config
})

// dial a peer
const conn = await node.dial(multiaddr('/ip4/...'), {
  signal: AbortSignal.timeout(1000)
})

// is the connection limited?
console.info(conn.limits?.seconds) // number | undefined
console.info(conn.limits?.bytes) // bigint | undefined

// register a protocol handler for incoming protocol dials
node.handle('/my-protocol/1.0.0', ({ stream, connection }) => {
  // handle protocol
}, {
   runOnLimitedConnection: true
})

// register a topology that is notified of peers connecting over limited
// connections
node.register('/my-protocol/1.0.0', {
  onConnect: (peer, connection) => {
    // handle connect
  },
  notifyOnLimitedConnection: true
})
```

## The CustomEvent polyfill has been removed from `@libp2p/interface`

The `@libp2p/interface` previously exported a [CustomEvent](https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent)
polyfill for compatibility with Node.js.

As of `v18.7.0`, Node.js ships with a global implementation of [CustomEvent](https://nodejs.org/docs/latest/api/globals.html#customevent)
so the polyfill is no longer necessary and it has been removed.

Please use the global implementation instead.

**Before**

```ts
import { CustomEvent } from '@libp2p/interface'

const event = new CustomEvent()
```

**After**

```ts
const event = new CustomEvent()
```

## `localPeer` is no longer passed to Connection Encrypters

Implementations of the [ConnectionEncrypter](https://libp2p.github.io/js-libp2p/interfaces/_libp2p_interface.ConnectionEncrypter.html)
interface should obtain the PeerID of the current node from the components map
instead of as an argument to the `secureInbound`/`secureOutbound` methods.

See [accessing libp2p components](https://github.com/libp2p/js-libp2p/blob/main/doc/SERVICES.md#accessing-libp2p-components)
in the guide to writing services.

If you use a connection encrypter like `noise` or `tls`, all you need to do is
upgrade to the latest version.

## The `.code` property has been removed from thrown errors, use `.name` instead

Errors thrown by libp2p previously had a `.code` property that lets the handler
differentiate between different error conditions.

The use of this was largely influenced by Node.js' use of `.code` in errors
thrown by the [fs](https://nodejs.org/docs/latest/api/fs.html) module.

Since then JavaScript has largely coalesced around using the [.name](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/name)
property instead.

**Before**

```ts
try {
  // a libp2p operation that may throw
} catch (err: any) {
  if (err.code === 'ERR_NOT_FOUND') {
    // handle the error appropriately
  }
}
```

**After**

```ts
try {
  // a libp2p operation that may throw
} catch (err: any) {
  if (err.name === 'NotFoundError') {
    // handle the error appropriately
  }
}
```

## pubsub, identify, circuit-relay v2 and record envelope sealing use `privateKey` component

The Peer ID of the current node contains a public/private keypair that is used
for various tasks including message signing and encryption.

The private key is stored in a serialized form that must be deserialized before
use.

In some parts of the codebase this happens many times in quick succession, so
there is a performance penalty that is incurred.

`libp2p@2.x.x` adds a `privateKey` [components](https://github.com/libp2p/js-libp2p/blob/main/doc/SERVICES.md#accessing-libp2p-components)
for use by libp2p services that contains the deserialized private key.

There are no migration instructions to take advantage of this other than
ensuring you have upgraded to the latest version of all libp2p services.
